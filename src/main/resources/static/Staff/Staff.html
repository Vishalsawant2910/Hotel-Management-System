<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" type="text/css" href="StaffStyle.css">
	<meta charset="UTF-8">
	<title>Staff Page</title>

	<link rel="icon" href="/android-chrome-512x512.png" type="image/x-icon">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous" />
	<script>
		let currentStaffId;

		async function fetchStaffs() {
			const searchQuery = document.getElementById('search').value.toLowerCase();
			const response = await fetch('/staffs');
			const staffs = await response.json();
			const table = document.getElementById('staffTable');
			const tbody = table.querySelector('tbody');
			while (tbody.firstChild) {
				tbody.removeChild(tbody.firstChild);
			}

			staffs.forEach(staff => {
				if (staff.firstName.toLowerCase().includes(searchQuery) ||
					staff.lastName.toLowerCase().includes(searchQuery) ||
					staff.phone.toString().includes(searchQuery) ||
					staff.position.toLowerCase().includes(searchQuery)
				) {
					const row = tbody.insertRow(-1);
					const idCell = row.insertCell(0);
					const firstNameCell = row.insertCell(1);
					const lastNameCell = row.insertCell(2);
					const emailCell = row.insertCell(3);
					const phoneCell = row.insertCell(4);
					const positionCell = row.insertCell(5);
					const salaryCell = row.insertCell(6);
					const actionsCell = row.insertCell(7);

					idCell.textContent = staff.staffID;
					firstNameCell.textContent = staff.firstName;
					lastNameCell.textContent = staff.lastName;
					emailCell.textContent = staff.email;
					phoneCell.textContent = staff.phone;
					positionCell.textContent = staff.position;
					salaryCell.textContent = staff.salary.toLocaleString();

					const editButton = document.createElement('button');
					editButton.textContent = 'Edit';
					editButton.className = 'btn btn-outline-success';
					editButton.addEventListener('click', () => {
						showEditModal(staff);
					});
					actionsCell.appendChild(editButton);

					const deleteButton = document.createElement('button');
					deleteButton.textContent = 'Delete';
					deleteButton.className = 'btn btn-outline-danger';
					deleteButton.addEventListener('click', async () => {
						const confirmDelete = confirm('Are you sure you want to delete this staff member?');
						if (confirmDelete) {
							const response = await fetch(`/staffs/${staff.staffID}`, {
								method: 'DELETE'
							});
							if (response.ok) {
								location.reload();
							} else {
								alert('Failed to delete staff.');
							}
						}
					});
					actionsCell.appendChild(deleteButton);

					const detailButton = document.createElement('button');
					detailButton.textContent = 'Details';
					detailButton.className = 'btn btn-outline-primary';
					detailButton.addEventListener('click', () => {
						showDetailModal(staff);
					});
					actionsCell.appendChild(detailButton);
				}
			});
		}

		function showEditModal(staff) {
			currentStaffId = staff.staffID;
			document.getElementById('editFirstName').value = staff.firstName;
			document.getElementById('editLastName').value = staff.lastName;
			document.getElementById('editEmail').value = staff.email;
			document.getElementById('editPhone').value = staff.phone;
			document.getElementById('editPosition').value = staff.position;
			document.getElementById('editSalary').value = staff.salary;
			document.getElementById('editModal').style.display = 'block';
		}

		function hideEditModal() {
			document.getElementById('editModal').style.display = 'none';
		}

		async function updateStaff(event) {
			event.preventDefault();
			const form = event.target;
			const formData = new FormData(form);
			const response = await fetch(`/staffs/${currentStaffId}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(Object.fromEntries(formData))
			});
			if (response.ok) {
				location.reload();
			} else {
				alert('Failed to update staff.');
			}
		}

		async function createStaff(event) {
			event.preventDefault();
			const form = event.target;
			const formData = new FormData(form);
			const response = await fetch('/staffs', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(Object.fromEntries(formData))
			});
			if (response.ok) {
				location.reload();
			} else {
				alert('Failed to create staff.');
			}
		}

		function showDetailModal(staff) {
			document.getElementById('detailModal').style.display = 'block';

			const reservationsTableBody = document.getElementById('reservationsTableBody');
			while (reservationsTableBody.firstChild) {
				reservationsTableBody.removeChild(reservationsTableBody.firstChild);
			}

			staff.reservations.forEach(reservation => {
				const row = reservationsTableBody.insertRow(-1);
				const idCell = row.insertCell(0);
				const checkInCell = row.insertCell(1);
				const checkOutCell = row.insertCell(2);
				const totalCell = row.insertCell(3);
				const personCell = row.insertCell(4);
				const roomCell = row.insertCell(5);

				idCell.textContent = reservation.reservationID;
				checkInCell.textContent = reservation.checkInTime;
				checkOutCell.textContent = reservation.checkOutTime;
				totalCell.textContent = reservation.total;
				personCell.textContent = reservation.person;
				roomCell.textContent = `Room ${reservation.room.roomNumber} (${reservation.room.roomType})`;
			});

			const serviceUsagesTableBody = document.getElementById('serviceUsagesTableBody');
			while (serviceUsagesTableBody.firstChild) {
				serviceUsagesTableBody.removeChild(serviceUsagesTableBody.firstChild);
			}

			staff.serviceUsages.forEach(serviceUsage => {
				const row = serviceUsagesTableBody.insertRow(-1);
				const idCell = row.insertCell(0);
				const timeInCell = row.insertCell(1);
				const timeOutCell = row.insertCell(2);
				const serviceCell = row.insertCell(3);

				idCell.textContent = serviceUsage.serviceUsageID;
				timeInCell.textContent = serviceUsage.timeIn;
				timeOutCell.textContent = serviceUsage.timeOut;
				serviceCell.textContent = serviceUsage.service.serviceName;
			});
		}

		function hideDetailModal() {
			document.getElementById('detailModal').style.display = 'none';
		}

		window.onclick = function (event) {
			if (event.target === document.getElementById('editModal')) {
				hideEditModal();
			}
			if (event.target === document.getElementById('detailModal')) {
				hideDetailModal();
			}
		}
		function showCreateModal() {
			document.getElementById('createModal').style.display = 'block';
		}

		function hideCreateModal() {
			document.getElementById('createModal').style.display = 'none';
		}

		function toggleCreateForm() {
			const form = document.getElementById('createStaffForm');
			if (form.style.maxHeight) {
				form.style.maxHeight = null;
			} else {
				form.style.maxHeight = form.scrollHeight + 'px';
			}
		}




	</script>
</head>

<body onload="fetchStaffs();">
	<div class="container">
	<nav class="navbar navbar-dark bg-dark">
		<a href="/index.html">Home</a>
		<a href="/Guest/Guest.html">Guest</a>
		<a href="/Room/Room.html">Room</a>
		<a href="/Reservation/Reservation.html">Reservation</a>
		<a href="/Service/Service.html">Service</a>
		<a href="/ServiceUsage/ServiceUsage.html">Service Usage</a>
		<a href="/Staff/Staff.html">Staff</a>
	</nav>
	</div>
	<div class="searchBar">
		<label for="search">Search:</label>
		<input type="text" id="search" placeholder="Search..." oninput="fetchStaffs();">
	</div>

	<div class="container" align="center">

		<button id="createStaffButton" onclick="toggleCreateForm();" class="btn btn-info">Create Staff</button>

	</div>


	<div align="center">
		<form onsubmit="createStaff(event);"id="createStaffForm"    class="formBlock" style="width: 400px;">
			<label for="firstName" style="text-align:center">First Name</label>
			<input type="text" id="firstName" name="firstName" placeholder="FirstName" required>


			<label for="lastName" style="text-align:center">Last Name</label>
			<input type="text" id="lastName" name="lastName" placeholder="LastName" required>


			<label for="email" style="text-align:center">Email</label>
			<input type="email" id="email" name="email" placeholder="name@example.com" required>


			<label for="phone" style="text-align:center">Phone</label>
			<input type="text" id="phone" name="phone" placeholder="Phone" required>


			<label for="position" style="text-align:center">Position</label>
			<input type="text" id="position" name="position" placeholder="Position" required>


			<label for="salary" style="text-align:center">Salary</label>
			<input type="number" id="salary" name="salary" placeholder="Salary" step="0.01" required>
			<br>

			<button type="submit" class="btn btn-success btn-lg" class="text-center" align="center"
				style="width: 200px; margin: 0 auto;">Create Staff</button>
		</form>
	</div>

	<div class="container mt-3">
		<table id="staffTable" class="table table-bordered">
			<thead>
				<tr>
					<th>ID</th>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Email</th>
					<th>Phone</th>
					<th>Position</th>
					<th>Salary</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>






	<div id="editModal">
		<div id="editModalContent" class="container-fluid" align="center">
			<h2>Edit Staff</h2>
			<form onsubmit="updateStaff(event);" class="formBlock" align="center" style="width: 400px;">
				<label for="editFirstName" style="font-weight: bold;">First Name:</label>
				<input type="text" id="editFirstName" name="firstName" class="text-center" required>

				<label for="editLastName" style="font-weight: bold;">Last Name:</label>
				<input type="text" id="editLastName" name="lastName" class="text-center" required>

				<label for="editEmail" style="font-weight: bold;">Email:</label>
				<input type="email" id="editEmail" name="email" class="text-center" required>

				<label for="editPhone" style="font-weight: bold;">Phone</label>
				<input type="text" id="editPhone" name="phone" class="text-center" required>

				<label for="editPosition" style="font-weight: bold;">Position:</label>
				<input type="text" id="editPosition" name="position" class="text-center" required>

				<label for="editSalary" style="font-weight: bold;">Salary:</label>
				<input type="number" id="editSalary" name="salary" class="text-center" step="0.01" required><br>

				<button type="submit" class="btn btn-success" style="width: 150px; margin: 0 auto;">Update
					Staff</button><br>
				<button type="button" class="btn btn-success" style="width: 100px; margin: 0 auto;"
					onclick="hideEditModal();">Cancel</button>
			</form>
		</div>
	</div>
	<div id="detailModal">
		<div id="detailModalContent">
			<h2>Staff Details</h2>
			<h3>Reservations that take care</h3>
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>Check-in</th>
						<th>Check-out</th>
						<th>Total</th>
						<th>Person</th>
						<th>Room</th>
					</tr>
				</thead>
				<tbody id="reservationsTableBody">
				</tbody>
			</table>
			<h3>Service that takes care</h3>
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>Time In</th>
						<th>Time Out</th>
						<th>Service</th>
					</tr>
				</thead>
				<tbody id="serviceUsagesTableBody">
				</tbody>
			</table>
			<button onclick="hideDetailModal()">Close</button>
		</div>
	</div>
</body>

</html>